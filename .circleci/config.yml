version: 2.1

commands: 
    run-tests:
        description: Install dependencies, load db and run tests
        steps:
          - checkout
          - run: bundle install --path vendor/bundle
          - run: bundle exec rake db:create db:schema:load
          - run: rake

executors:
    docker-ruby:
        parameters:
            tag:
                type: string
        docker:
            - image: circleci/ruby:<< parameters.tag >>
            - image: circleci/postgres:9.4.12-alpine

workflows:
  ruby-test:
    jobs: # run test suite concurrently on different versions of Ruby
      - ruby-2-2
      - ruby-2-3
      - ruby-2-4

jobs:
  ruby-2-2:
    executor: 
        name: docker-ruby
        tag: "2.2-node"
    working_directory: ~/circleci-demo-workflows
    steps:
      - run-tests

  ruby-2-3:
    executor: 
        name: docker-ruby
        tag: "2.3-node"
    working_directory: ~/circleci-demo-workflows
    steps:
      - run-tests

  ruby-2-4:
    executor: 
        name: docker-ruby
        tag: "2.4-node"
    working_directory: ~/circleci-demo-workflows
    steps:
      - run-tests
